

1. Manage sections 
2. kailangang pagaralan yung ERD

CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  email VARCHAR(190) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NULL,
  role ENUM('admin','registrar','professor','student') NOT NULL DEFAULT 'student',
  name_first VARCHAR(100),
  name_last VARCHAR(100),
  status ENUM('ACTIVE','INACTIVE') DEFAULT 'ACTIVE',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE students (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT UNIQUE,
  student_id VARCHAR(50) UNIQUE,
  year_level ENUM('1','2','3','4') NOT NULL,
  section VARCHAR(50),
  status ENUM('Regular','Irregular') DEFAULT 'Regular',
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
);

CREATE TABLE professors (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT UNIQUE,
  professor_id VARCHAR(50) UNIQUE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
);

-- COURSES / SECTIONS / ENROLLMENTS
CREATE TABLE courses (
  id INT AUTO_INCREMENT PRIMARY KEY,
  code VARCHAR(50) UNIQUE,
  title VARCHAR(190) NOT NULL,
  units INT DEFAULT 3
);

CREATE TABLE sections (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(50) NOT NULL,
  year_level ENUM('1','2','3','4') NOT NULL,
  term VARCHAR(50),
  course_id INT NULL,
  FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE SET NULL
);

CREATE TABLE enrollments (
  id INT AUTO_INCREMENT PRIMARY KEY,
  section_id INT NOT NULL,
  student_id INT NOT NULL, 
  FOREIGN KEY (section_id) REFERENCES sections(id) ON DELETE CASCADE,
  FOREIGN KEY (student_id) REFERENCES students(id) ON DELETE CASCADE
);

-- GRADING
CREATE TABLE grading_sheets (
  id INT AUTO_INCREMENT PRIMARY KEY,
  section_id INT NOT NULL,
  professor_id INT NOT NULL, 
  status ENUM('draft','submitted','locked','reopened') DEFAULT 'draft',
  deadline_at DATETIME NULL,
  submitted_at DATETIME NULL,
  FOREIGN KEY (section_id) REFERENCES sections(id) ON DELETE CASCADE,
  FOREIGN KEY (professor_id) REFERENCES professors(id) ON DELETE CASCADE
);

CREATE TABLE grade_components (
  id INT AUTO_INCREMENT PRIMARY KEY,
  section_id INT NOT NULL,
  name VARCHAR(50) NOT NULL,  
  weight DECIMAL(5,2) NOT NULL,
  FOREIGN KEY (section_id) REFERENCES sections(id) ON DELETE CASCADE
);

CREATE TABLE grade_items (
  id INT AUTO_INCREMENT PRIMARY KEY,
  component_id INT NOT NULL,
  title VARCHAR(100) NOT NULL,
  total_points DECIMAL(7,2) NOT NULL,
  FOREIGN KEY (component_id) REFERENCES grade_components(id) ON DELETE CASCADE
);

CREATE TABLE grades (
  id INT AUTO_INCREMENT PRIMARY KEY,
  grade_item_id INT NOT NULL,
  student_id INT NOT NULL,         
  score DECIMAL(7,2) NOT NULL,
  FOREIGN KEY (grade_item_id) REFERENCES grade_items(id) ON DELETE CASCADE,
  FOREIGN KEY (student_id) REFERENCES students(id) ON DELETE CASCADE
);

CREATE TABLE edit_requests (
  id INT AUTO_INCREMENT PRIMARY KEY,
  grading_sheet_id INT NOT NULL,
  professor_id INT NOT NULL,
  reason TEXT,
  status ENUM('pending','approved','denied') DEFAULT 'pending',
  decided_by INT NULL, 
  decided_at DATETIME NULL,
  FOREIGN KEY (grading_sheet_id) REFERENCES grading_sheets(id) ON DELETE CASCADE,
  FOREIGN KEY (professor_id) REFERENCES professors(id) ON DELETE CASCADE
);

CREATE TABLE activity_logs (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NULL,
  action VARCHAR(100) NOT NULL,
  details TEXT,
  ip VARCHAR(45),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
);

CREATE TABLE document_requests (
  id INT AUTO_INCREMENT PRIMARY KEY,
  student_id INT NOT NULL,
  type ENUM('report','certificate') NOT NULL,
  purpose VARCHAR(190),
  status ENUM('pending','scheduled','ready','released') DEFAULT 'pending',
  scheduled_at DATETIME NULL,
  released_at DATETIME NULL,
  FOREIGN KEY (student_id) REFERENCES students(id) ON DELETE CASCADE
);


CREATE TABLE IF NOT EXISTS subjects (
    id INT AUTO_INCREMENT PRIMARY KEY,
    subject_code VARCHAR(50) NOT NULL,
    subject_title VARCHAR(200) NOT NULL,
    units DECIMAL(3,1) DEFAULT 0,
    description TEXT DEFAULT NULL,
    is_active TINYINT(1) DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uq_subjects_code (subject_code)
);
CREATE TABLE IF NOT EXISTS terms (
    id INT AUTO_INCREMENT PRIMARY KEY,
    term_name VARCHAR(100) NOT NULL,      -- e.g. "1st Semester 2025-2026"
    school_year VARCHAR(20) DEFAULT NULL, -- e.g. "2025-2026"
    start_date DATE DEFAULT NULL,
    end_date DATE DEFAULT NULL,
    is_active TINYINT(1) DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);


ALTER TABLE users
CHANGE COLUMN name_first first_name VARCHAR(100) NOT NULL;

ALTER TABLE users
CHANGE COLUMN name_last last_name VARCHAR(100) NOT NULL;

ALTER TABLE students
ADD COLUMN ptc_email VARCHAR(150) DEFAULT NULL AFTER student_id,
ADD COLUMN first_name VARCHAR(100) NOT NULL AFTER ptc_email,
ADD COLUMN middle_name VARCHAR(100) DEFAULT NULL AFTER first_name,
ADD COLUMN last_name VARCHAR(100) NOT NULL AFTER middle_name;

ALTER TABLE students
ADD UNIQUE KEY uq_students_ptc_email (ptc_email);


INSERT INTO students (student_id, ptc_email, first_name, middle_name, last_name, year_level, section, status)
VALUES ('STUD-0002', 'maria.santos@ptc.edu.ph', 'Maria', 'Luna', 'Santos', '3', 'BSIT-3A', 'Regular');


UPDATE students
SET 
student_id = '2022-9800'
ptc_email = 'maria.santos@paterostechnologicalcollege.edu.ph'
section = 'BSIT-3OL'
WHERE id = 2;


ALTER TABLE professors
    MODIFY professor_id VARCHAR(50) NOT NULL;


ALTER TABLE professors
    ADD COLUMN ptc_email VARCHAR(150) NOT NULL AFTER professor_id,
    ADD COLUMN first_name VARCHAR(100) NOT NULL AFTER ptc_email,
    ADD COLUMN middle_name VARCHAR(100) DEFAULT NULL AFTER first_name,
    ADD COLUMN last_name VARCHAR(100) NOT NULL AFTER middle_name,
    ADD COLUMN is_active TINYINT(1) DEFAULT 1 AFTER last_name,
    ADD COLUMN created_at DATETIME DEFAULT CURRENT_TIMESTAMP AFTER is_active,
    ADD COLUMN updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP AFTER created_at;

ALTER TABLE professors
    ADD UNIQUE KEY uq_professors_ptc_email (ptc_email);

ALTER TABLE sections
    CHANGE COLUMN name section_name VARCHAR(100) NOT NULL;

ALTER TABLE sections
    ADD COLUMN term_id INT NULL AFTER section_name,
    ADD COLUMN subject_id INT NULL AFTER term_id,
    ADD COLUMN schedule VARCHAR(150) NULL AFTER subject_id,
    ADD COLUMN assigned_professor_id INT NULL AFTER schedule,
    ADD COLUMN is_active TINYINT(1) DEFAULT 1 AFTER assigned_professor_id,
    ADD COLUMN created_at DATETIME DEFAULT CURRENT_TIMESTAMP AFTER is_active,
    ADD COLUMN updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP AFTER created_at;


ALTER TABLE sections
    ADD CONSTRAINT fk_sections_term
        FOREIGN KEY (term_id) REFERENCES terms(id)
        ON UPDATE CASCADE ON DELETE SET NULL,
    ADD CONSTRAINT fk_sections_subject
        FOREIGN KEY (subject_id) REFERENCES subjects(id)
        ON UPDATE CASCADE ON DELETE SET NULL;

ALTER TABLE sections
    ADD CONSTRAINT fk_sections_professor
        FOREIGN KEY (assigned_professor_id) REFERENCES professors(id)
        ON UPDATE CASCADE ON DELETE SET NULL;



INSERT INTO professors (
  professor_id, ptc_email, first_name, middle_name, last_name,
  is_active, created_at, updated_at
)
VALUES
  ('PROF-0002', 'storre@paterostechnologicalcollege.edu.ph', 'Shider Rey', 'Dela Cruz', 'Toree', 1, NOW(), NOW()),
  ('PROF-0003', 'rnacario@paterostechnologicalcollege.edu.ph', 'Ryan Cesar', 'Legaspi', 'Nacario', 1, NOW(), NOW()),
  ('PROF-0004', 'mknazareno@paterostechnologicalcollege.edu.ph', 'Mark Kenneth', 'Borja', 'Nazareno', 0, NOW(), NOW());

INSERT INTO terms (
  term_name, school_year, start_date, end_date, is_active, created_at, updated_at
)
VALUES
  ('1st Semester 2025-2026', '2025-2026', '2025-08-01', '2025-12-15', 1, NOW(), NOW()),
  ('2nd Semester 2025-2026', '2025-2026', '2026-01-10', '2026-05-15', 0, NOW(), NOW());

 
INSERT INTO subjects (
  subject_code, subject_title, units, description, is_active, created_at, updated_at
)
VALUES
  ('AIS101', 'Information Assurance and Security', 3, 'About securities in IT field', 1, NOW(), NOW()),
  ('FIL1', 'Komunikasyon sa Akademikong Filipino', 3, 'Pagpapahalaga sa ating Wika', 1, NOW(), NOW()),
  ('DLD1', 'Digital Logic Design', 3, 'Covers Binary', 1, NOW(), NOW());


INSERT INTO sections (
  section_name, year_level, term_id, subject_id, schedule, assigned_professor_id,
  is_active, created_at, updated_at
)
VALUES
  ('BSIT 1A', '1', 1, 1, 'MWF 8:00-9:00 AM', 8, 1, NOW(), NOW()),
  ('BSIT 2B', '2', 1, 2, 'TTH 9:00-10:30 AM', 9, 1, NOW(), NOW()),
  ('BSIT 3C', '3', 1, 3, 'MWF 1:00-2:30 PM', 10, 1, NOW(), NOW());


ALTER TABLE terms
  ADD COLUMN semester ENUM('1','2') NOT NULL DEFAULT '1' AFTER id;

UPDATE terms
SET term_name = CONCAT(
  CASE semester WHEN '1' THEN '1st Semester ' WHEN '2' THEN '2nd Semester ' END,
  school_year
);

